<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gear Finder - Bitcraft Market Helper</title>
    <!-- Shared styles for enhanced UI mode -->
    <link rel="stylesheet" href="shared-styles.css" id="sharedStyles" disabled>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4a9eff;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-links a {
            color: #4a9eff;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 4px;
            background-color: #2a2a2a;
            display: inline-block;
        }

        .nav-links a:hover {
            background-color: #3a3a3a;
        }

        .filters-section {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .filters-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-size: 14px;
        }

        select {
            width: 100%;
            padding: 10px;
            background-color: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        select[multiple] {
            min-height: 120px;
            padding: 5px;
        }

        select[multiple] option {
            padding: 8px 10px;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        select[multiple] option:checked {
            background: linear-gradient(#4a9eff, #4a9eff);
            color: #1a1a1a;
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #b0b0b0;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .refresh-button {
            padding: 10px 20px;
            background-color: #4a9eff;
            color: #1a1a1a;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .refresh-button:hover {
            background-color: #6bb3ff;
        }

        .refresh-button:disabled {
            background-color: #4a4a4a;
            color: #6b7280;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            text-align: center;
            padding: 40px;
            background-color: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading-overlay.active {
            display: block;
        }

        .spinner {
            border: 4px solid #3a3a3a;
            border-top: 4px solid #4a9eff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #4a9eff;
            font-size: 16px;
        }

        .loading-details {
            color: #b0b0b0;
            font-size: 14px;
            margin-top: 10px;
        }

        .results-section {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            color: #4a9eff;
            font-size: 18px;
        }

        .search-box {
            padding: 8px 12px;
            background-color: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
            width: 300px;
        }

        .search-box:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background-color: #3a3a3a;
            padding: 12px 8px;
            text-align: left;
            color: #4a9eff;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background-color: #4a4a4a;
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
        }

        th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #3a3a3a;
        }

        tr:hover {
            background-color: #2a2a2a;
        }

        .price-cell {
            color: #4ade80;
            font-weight: 500;
        }

        .price-with-claim {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .claim-name {
            color: #9ca3af;
            font-size: 11px;
            font-style: italic;
        }

        .price-na {
            color: #6b7280;
            font-style: italic;
        }

        .item-link {
            color: #4a9eff;
            text-decoration: none;
        }

        .item-link:hover {
            text-decoration: underline;
            color: #6bb3ff;
        }

        .no-results {
            text-align: center;
            color: #b0b0b0;
            padding: 40px;
            font-style: italic;
        }

        .info-message {
            text-align: center;
            color: #b0b0b0;
            padding: 40px;
            background-color: #2a2a2a;
            border-radius: 8px;
            font-size: 16px;
        }

        .error {
            background-color: #4a2a2a;
            color: #f87171;
            padding: 15px;
            border-radius: 4px;
            border-left: 3px solid #f87171;
            margin-bottom: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .attribution-footer {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 40px;
            text-align: center;
            border-top: 2px solid #4a9eff;
        }

        .attribution-footer p {
            color: #b0b0b0;
            font-size: 14px;
            margin: 0;
        }

        .attribution-footer a {
            color: #4a9eff;
            text-decoration: none;
            font-weight: 600;
        }

        .attribution-footer a:hover {
            color: #6bb3ff;
            text-decoration: underline;
        }

        /* Tooltip Styles */
        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            background-color: #4a9eff;
            color: #1a1a1a;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 6px;
            position: relative;
            vertical-align: middle;
        }

        .help-icon:hover {
            background-color: #6bb3ff;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 2000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4a9eff;
            font-size: 13px;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #4a9eff transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .help-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: #2a2a2a;
            color: #4a9eff;
            text-decoration: none;
            border-radius: 4px;
            border: 1px solid #4a9eff;
            transition: background-color 0.2s;
        }

        .help-link:hover {
            background-color: #3a3a3a;
        }

        /* Saved Searches Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #4a9eff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a4a4a;
        }

        .modal-header h2 {
            color: #4a9eff;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: #4a4a4a;
        }

        .saved-search-item {
            background-color: #3a3a3a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 3px solid #4a9eff;
        }

        .saved-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .saved-search-name {
            color: #e0e0e0;
            font-weight: 600;
            font-size: 16px;
            flex: 1;
        }

        .saved-search-actions {
            display: flex;
            gap: 8px;
        }

        .saved-search-btn {
            padding: 6px 12px;
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .saved-search-btn:hover {
            background-color: #5a5a5a;
        }

        .saved-search-btn.load {
            background-color: #4a9eff;
            color: #1a1a1a;
        }

        .saved-search-btn.load:hover {
            background-color: #6bb3ff;
        }

        .saved-search-btn.delete {
            background-color: #f87171;
            color: #1a1a1a;
        }

        .saved-search-btn.delete:hover {
            background-color: #fb923c;
        }

        .saved-search-details {
            color: #b0b0b0;
            font-size: 13px;
        }

        .saved-search-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            background-color: #4a4a4a;
            color: #4a9eff;
            font-size: 11px;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #4a4a4a;
            display: flex;
            gap: 10px;
        }

        .modal-button {
            padding: 10px 20px;
            background-color: #4a9eff;
            color: #1a1a1a;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: #6bb3ff;
        }

        .modal-button.secondary {
            background-color: #4a4a4a;
            color: #e0e0e0;
        }

        .modal-button.secondary:hover {
            background-color: #5a5a5a;
        }

        .empty-state {
            text-align: center;
            color: #b0b0b0;
            padding: 30px;
            font-style: italic;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            padding: 15px 20px;
            border-radius: 8px;
            border: 2px solid #4a9eff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 4000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-color: #4ade80;
        }

        .toast.error {
            border-color: #f87171;
        }

        .toast.warning {
            border-color: #fb923c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .filters-row {
                flex-direction: column;
            }

            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .search-box {
                width: 100%;
            }

            .tooltip .tooltiptext {
                width: 200px;
                margin-left: -100px;
            }

            .modal-content {
                padding: 20px;
            }

            .toast {
                right: 15px;
                left: 15px;
                bottom: 15px;
            }
        }

        .cargo-label {
            background-color: #fb923c;
            color: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
        }
        /* Player Header Styles */
        .player-header {
            background-color: #2a2a2a;
            border-bottom: 2px solid #4a4a4a;
            padding: 10px 20px;
            margin: -20px -20px 20px -20px;
        }

        .player-header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .player-search-container {
            position: relative;
            flex: 0 0 300px;
        }

        .player-search-input {
            width: 100%;
            padding: 8px 12px;
            background-color: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }

        .player-search-input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .player-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
        }

        .player-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #2a2a2a;
        }

        .player-result-item:hover {
            background-color: #4a4a4a;
        }

        .player-result-item:last-child {
            border-bottom: none;
        }

        .player-result-username {
            color: #4a9eff;
            font-weight: 500;
            font-size: 14px;
        }

        .player-result-details {
            color: #b0b0b0;
            font-size: 11px;
            margin-top: 2px;
        }

        .player-result-online {
            color: #4ade80;
        }

        .player-result-offline {
            color: #f87171;
        }

        .current-player-display {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .current-player-name {
            color: #4a9eff;
            font-weight: 500;
        }

        .player-clear-btn {
            padding: 4px 10px;
            background-color: #f87171;
            color: #1a1a1a;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .player-clear-btn:hover {
            background-color: #ff8a8a;
        }

        @media (max-width: 768px) {
            .player-header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .player-search-container {
                flex: 1 1 auto;
            }
        }
    </style>
</head>
<body>
    <!-- Player ID Header -->
    <div class="player-header">
        <div class="player-header-content">
            <div class="player-search-container">
                <input
                    type="text"
                    id="playerSearchInput"
                    class="player-search-input"
                    placeholder="üîç Search for your player name..."
                    autocomplete="off"
                >
                <div class="player-results-dropdown" id="playerResultsDropdown"></div>
            </div>
            <div class="current-player-display" id="currentPlayerDisplay">
                <span style="color: #b0b0b0;">No player selected</span>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>‚öîÔ∏è Gear Finder - Bitcraft Market Helper
            <span class="tooltip">
                <span class="help-icon">?</span>
                <span class="tooltiptext">Browse and compare gear items by category, tier, and rarity. View prices across all rarity levels in a convenient table format.</span>
            </span>
        </h1>

        <div class="nav-links">
            <a href="dashboard.html">üìä Dashboard</a>
            <a href="index.html">‚Üê Back to Market Search</a>
            <a href="market-monitor.html">üìä Market Monitor</a>
            <a href="help.html" class="help-link">üìö Help & FAQ</a>
        </div>

        <div class="filters-section">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                    <label for="savedSearchSelect">Saved Searches
                        <span class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Load a previously saved search. Save your current filters using the button below to quickly access them later.</span>
                        </span>
                    </label>
                    <select id="savedSearchSelect">
                        <option value="">-- Load Saved Search --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button id="saveSearchButton" class="refresh-button" style="background-color: #4ade80;">üíæ Save Filters</button>
                    <button id="manageSearchesButton" class="refresh-button" style="background-color: #a78bfa;">‚öôÔ∏è Manage</button>
                    <span id="savedIndicator" style="display: none; color: #4ade80; font-size: 14px;">‚≠ê Saved</span>
                </div>
            </div>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="categoryFilter">Category (Ctrl+Click for multiple)
                        <span class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Select one or more gear categories to view. Hold Ctrl (or Cmd on Mac) and click to select multiple categories.</span>
                        </span>
                    </label>
                    <select id="categoryFilter" multiple>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="tierFilter">Tier (Ctrl+Click for multiple)
                        <span class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Filter by item tier levels. Hold Ctrl (or Cmd on Mac) and click to select multiple tiers.</span>
                        </span>
                    </label>
                    <select id="tierFilter" multiple>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="rarityFilter">Rarity (Ctrl+Click for multiple)
                        <span class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Filter by item rarity (Common, Uncommon, Rare, Epic, Legendary). Hold Ctrl (or Cmd on Mac) and click to select multiple rarities.</span>
                        </span>
                    </label>
                    <select id="rarityFilter" multiple>
                    </select>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="checkbox-group">
                    <input type="checkbox" id="allRegions">
                    <label for="allRegions">Include all regions (default: Solvenar - Region 4)
                        <span class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">By default, only shows market data from Solvenar (Region 4). Check this box to include market data from all regions.</span>
                        </span>
                    </label>
                </div>
                <button id="refreshButton" class="refresh-button" disabled>üîÑ Refresh Data
                    <span class="tooltip">
                        <span class="help-icon" style="background-color: #1a1a1a; color: #4a9eff;">?</span>
                        <span class="tooltiptext">Reload market data with current filter settings to get the latest prices. Button activates after selecting filters.</span>
                    </span>
                </button>
            </div>
        </div>

        <div class="error" id="errorMessage"></div>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">Fetching market data...</div>
            <div class="loading-details" id="loadingDetails">Preparing request...</div>
        </div>

        <div class="info-message" id="infoMessage">
            Select category, tier, or rarity filters above to view market data.
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-count" id="resultsCount">0 items found</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchBox" class="search-box" placeholder="Quick filter by name...">
                    <button class="refresh-button" onclick="toggleColumnFilters()" id="columnFilterToggle" style="background-color: #a78bfa; padding: 8px 16px;">üîç Column Filters</button>
                    <button class="refresh-button" onclick="exportToCSV()" style="background-color: #4ade80; padding: 8px 16px;">üì• Export CSV</button>
                    <span class="tooltip">
                        <span class="help-icon">?</span>
                        <span class="tooltiptext">Use quick filter to search by name, or enable column filters for advanced filtering by price, tier, and category.</span>
                    </span>
                </div>
            </div>

            <!-- Column Filters -->
            <div id="columnFiltersPanel" style="display: none; background-color: #2a2a2a; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #4a4a4a;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="color: #4a9eff; margin: 0; font-size: 16px;">Column Filters</h3>
                    <button class="refresh-button" onclick="clearColumnFilters()" style="background-color: #f87171; padding: 6px 12px; font-size: 13px;">Clear All Filters</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div>
                        <label style="color: #b0b0b0; font-size: 12px; margin-bottom: 4px; display: block;">Item Name</label>
                        <input type="text" id="filterItemName" class="search-box" placeholder="Filter by name..." style="width: 100%; font-size: 13px; padding: 8px;">
                    </div>
                    <div>
                        <label style="color: #b0b0b0; font-size: 12px; margin-bottom: 4px; display: block;">Tier</label>
                        <select id="filterTier" style="width: 100%; padding: 8px; background-color: #3a3a3a; border: 1px solid #4a4a4a; border-radius: 4px; color: #e0e0e0; font-size: 13px;">
                            <option value="">All Tiers</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #b0b0b0; font-size: 12px; margin-bottom: 4px; display: block;">Category</label>
                        <input type="text" id="filterCategory" class="search-box" placeholder="Filter by category..." style="width: 100%; font-size: 13px; padding: 8px;">
                    </div>
                    <div>
                        <label style="color: #b0b0b0; font-size: 12px; margin-bottom: 4px; display: block;">Min Price (any rarity)</label>
                        <input type="number" id="filterMinPrice" class="search-box" placeholder="Min..." style="width: 100%; font-size: 13px; padding: 8px;">
                    </div>
                    <div>
                        <label style="color: #b0b0b0; font-size: 12px; margin-bottom: 4px; display: block;">Max Price (any rarity)</label>
                        <input type="number" id="filterMaxPrice" class="search-box" placeholder="Max..." style="width: 100%; font-size: 13px; padding: 8px;">
                    </div>
                    <div>
                        <label style="color: #b0b0b0; font-size: 12px; margin-bottom: 4px; display: block;">Specific Rarity</label>
                        <select id="filterRarity" style="width: 100%; padding: 8px; background-color: #3a3a3a; border: 1px solid #4a4a4a; border-radius: 4px; color: #e0e0e0; font-size: 13px;">
                            <option value="">All Rarities</option>
                            <option value="common">Common</option>
                            <option value="uncommon">Uncommon</option>
                            <option value="rare">Rare</option>
                            <option value="epic">Epic</option>
                            <option value="legendary">Legendary</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #3a3a3a;">
                    <span style="color: #6b7280; font-size: 12px;">üí° Tip: Leave fields empty to show all. Price filters check if ANY rarity price matches.</span>
                </div>
            </div>
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="itemName">Item Name
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Click to sort by item name. Click links to view items on bitjita.com.</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="tier">Tier
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Click to sort by tier level. Higher tiers are generally more powerful.</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="common">Common
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Lowest sell price for Common rarity of this item. Click column to sort by price.</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="uncommon">Uncommon
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Lowest sell price for Uncommon rarity of this item. Click column to sort by price.</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="rare">Rare
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Lowest sell price for Rare rarity of this item. Click column to sort by price.</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="epic">Epic
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Lowest sell price for Epic rarity of this item. Click column to sort by price.</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="legendary">Legendary
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Lowest sell price for Legendary rarity of this item. Click column to sort by price.</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="category">Category
                                <span class="tooltip">
                                    <span class="help-icon" style="width: 14px; height: 14px; font-size: 10px;">?</span>
                                    <span class="tooltiptext">Item category (e.g., Miner Tool, Metal Armor). Click to sort.</span>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="attribution-footer">
            <p>Market data graciously provided by <a href="https://bitjita.com" target="_blank">bitjita.com</a> üíô</p>
        </div>
    </div>

    <!-- Manage Saved Searches Modal -->
    <div class="modal-overlay" id="manageSearchesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìö Manage Saved Searches</h2>
                <button class="modal-close" onclick="closeManageModal()">&times;</button>
            </div>
            <div id="savedSearchesList"></div>
            <div class="modal-footer">
                <button class="modal-button" onclick="exportSearches()">üì• Export</button>
                <button class="modal-button secondary" onclick="importSearches()">üì§ Import</button>
                <button class="modal-button secondary" onclick="clearAllSearches()">üóëÔ∏è Clear All</button>
            </div>
            <input type="file" id="importFileInput" style="display: none;" accept=".json">
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- UI Version Toggle -->
    <div class="version-toggle" id="versionToggle" style="position: fixed; bottom: 20px; left: 20px; z-index: 1000; background-color: #2a2a2a; padding: 8px 15px; border-radius: 6px; border: 1px solid #4a4a4a; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
        <label style="margin: 0; font-size: 12px; color: #b0b0b0; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <input type="checkbox" id="uiVersionToggle" style="width: 16px; height: 16px; cursor: pointer;">
            Enhanced UI
        </label>
    </div>

    <!-- Configuration and utilities -->
    <script src="config-browser.js"></script>
    <script src="cache-manager.js"></script>
    <script src="shared-utils.js"></script>
    <script src="savedSearches.js"></script>
    <script src="favorites.js"></script>
    <script>
        // ==========================================
        // API CONFIGURATION
        // ==========================================
        // For LOCAL development: Leave this empty ('')
        // For GITHUB PAGES: Set this to your Cloudflare Worker URL
        // Example: 'https://bitcraft-market-proxy.YOUR_SUBDOMAIN.workers.dev'
        const API_BASE_URL = 'https://bitcraft-market-proxy.jbaird-cb6.workers.dev';

        // ==========================================
        // PLAYER ID MANAGEMENT
        // ==========================================
        const PLAYER_STORAGE_KEY = 'bitcraft_player_id';
        let currentPlayer = null;
        let playerSearchTimeout = null;

        // Get current player from localStorage
        function getCurrentPlayer() {
            const stored = localStorage.getItem(PLAYER_STORAGE_KEY);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse stored player data:', e);
                    return null;
                }
            }
            return null;
        }

        // Get current player's entity ID (for use in other features)
        function getCurrentPlayerId() {
            return currentPlayer ? currentPlayer.entityId : null;
        }

        // Save player to localStorage
        function savePlayer(player) {
            localStorage.setItem(PLAYER_STORAGE_KEY, JSON.stringify(player));
            currentPlayer = player;
            updatePlayerDisplay();
        }

        // Clear saved player
        function clearPlayer() {
            localStorage.removeItem(PLAYER_STORAGE_KEY);
            currentPlayer = null;
            updatePlayerDisplay();
            document.getElementById('playerSearchInput').value = '';
        }

        // Update player display in header
        function updatePlayerDisplay() {
            const displayElement = document.getElementById('currentPlayerDisplay');
            if (!displayElement) return;

            if (currentPlayer) {
                const hoursPlayed = Math.floor(currentPlayer.timePlayed / 3600);
                displayElement.innerHTML = `
                    <span style="color: #b0b0b0;">Player:</span>
                    <span class="current-player-name">${currentPlayer.username}</span>
                    <span style="color: #b0b0b0; font-size: 12px;">(${hoursPlayed}h played)</span>
                    <button class="player-clear-btn" onclick="clearPlayer()">‚úï Clear</button>
                `;
            } else {
                displayElement.innerHTML = '<span style="color: #b0b0b0;">No player selected</span>';
            }
        }

        // Search for players via API
        async function searchPlayers(query) {
            if (!query || query.trim().length < 2) {
                document.getElementById('playerResultsDropdown').style.display = 'none';
                return;
            }

            try {
                // Use worker proxy to avoid CORS issues
                const apiUrl = API_BASE_URL
                    ? `${API_BASE_URL}/api/players?q=${encodeURIComponent(query)}`
                    : `https://bitjita.com/api/players?q=${encodeURIComponent(query)}`;

                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const data = await response.json();
                displayPlayerResults(data.players || []);
            } catch (error) {
                console.error('Player search failed:', error);
                const dropdown = document.getElementById('playerResultsDropdown');
                dropdown.innerHTML = '<div class="player-result-item"><span style="color: #f87171;">Search failed. Please try again.</span></div>';
                dropdown.style.display = 'block';
            }
        }

        // Display player search results
        function displayPlayerResults(players) {
            const dropdown = document.getElementById('playerResultsDropdown');

            if (players.length === 0) {
                dropdown.innerHTML = '<div class="player-result-item"><span style="color: #b0b0b0;">No players found</span></div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = players.map(player => {
                const hoursPlayed = Math.floor(player.timePlayed / 3600);
                const statusClass = player.signedIn ? 'player-result-online' : 'player-result-offline';
                const statusText = player.signedIn ? 'Online' : 'Offline';
                const createdDate = new Date(player.createdAt).toLocaleDateString();

                return `
                    <div class="player-result-item" onclick='selectPlayer(${JSON.stringify(player)})'>
                        <div class="player-result-username">${player.username}</div>
                        <div class="player-result-details">
                            <span class="${statusClass}">${statusText}</span> ‚Ä¢
                            ${hoursPlayed}h played ‚Ä¢
                            Created ${createdDate}
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
        }

        // Select a player from search results
        function selectPlayer(player) {
            savePlayer(player);
            document.getElementById('playerSearchInput').value = player.username;
            document.getElementById('playerResultsDropdown').style.display = 'none';

            // Show success toast
            showToast(`Player ${player.username} selected!`, 'success');
        }

        // Initialize player search on page load
        function initPlayerSearch() {
            const searchInput = document.getElementById('playerSearchInput');
            const dropdown = document.getElementById('playerResultsDropdown');

            if (!searchInput || !dropdown) return;

            // Load saved player
            currentPlayer = getCurrentPlayer();
            updatePlayerDisplay();

            // Search input handler with debounce
            searchInput.addEventListener('input', (e) => {
                clearTimeout(playerSearchTimeout);
                playerSearchTimeout = setTimeout(() => {
                    searchPlayers(e.target.value);
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });

            // Focus shows dropdown if there are results
            searchInput.addEventListener('focus', () => {
                if (dropdown.innerHTML && searchInput.value.trim().length >= 2) {
                    dropdown.style.display = 'block';
                }
            });
        }

        // ==========================================
        // Don't modify below this line
        // ==========================================
        let allItems = [];
        let currentResults = [];
        let currentSort = { column: 'category', direction: 'asc' };
        let currentAbortController = null;

        const CATEGORIES = [
            'Blacksmith Tool',
            'Cargo',
            'Carpenter Tool',
            'Cloth Clothing',
            'Farmer Tool',
            'Fisher Tool',
            'Forager Tool',
            'Forester Tool',
            'Hunter Tool',
            'Leather Clothing',
            'Leatherworker Tool',
            'Mason Tool',
            'Metal Armor',
            'Miner Tool',
            'Scholar Tool',
            'Tailor Tool'
        ];

        const RARITIES = ['Common', 'Uncommon', 'Rare', 'Epic', 'Legendary'];

        // Load items.json and cargo.json on startup
        async function loadItems() {
            try {
                // Load regular items
                const itemsResponse = await fetch('items.json');
                const itemsData = await itemsResponse.json();
                const items = (itemsData.items || []).map(item => ({
                    ...item,
                    itemType: 'item'
                }));

                // Load cargo items
                let cargo = [];
                try {
                    const cargoResponse = await fetch('cargo.json');
                    const cargoData = await cargoResponse.json();
                    cargo = (cargoData.cargos || []).map(cargoItem => ({
                        ...cargoItem,
                        itemType: 'cargo',
                        tag: 'Cargo' // Ensure cargo items have tag='Cargo' for filtering
                    }));
                } catch (cargoError) {
                    console.warn('cargo.json not found or failed to load:', cargoError.message);
                }

                // Merge items and cargo
                allItems = [...items, ...cargo];

                populateDropdowns();
                setupEventListeners();

                console.log(`Loaded ${items.length} items and ${cargo.length} cargo`);
            } catch (error) {
                showError('Failed to load items.json: ' + error.message);
            }
        }

        // Populate dropdowns with unique values
        function populateDropdowns() {
            // Populate categories
            const categoryFilter = document.getElementById('categoryFilter');
            CATEGORIES.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });

            // Populate tiers
            const tierSet = new Set();
            allItems.forEach(item => {
                if ((item.compendiumEntry === true || item.itemType === 'cargo') && CATEGORIES.includes(item.tag)) {
                    tierSet.add(item.tier);
                }
            });
            const tiers = Array.from(tierSet).sort((a, b) => a - b);

            const tierFilter = document.getElementById('tierFilter');
            tiers.forEach(tier => {
                const option = document.createElement('option');
                option.value = tier;
                option.textContent = `Tier ${tier}`;
                tierFilter.appendChild(option);
            });

            // Populate rarities
            const rarityFilter = document.getElementById('rarityFilter');
            RARITIES.forEach(rarity => {
                const option = document.createElement('option');
                option.value = rarity;
                option.textContent = rarity;
                rarityFilter.appendChild(option);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('categoryFilter').addEventListener('change', handleFilterChange);
            document.getElementById('tierFilter').addEventListener('change', handleFilterChange);
            document.getElementById('rarityFilter').addEventListener('change', handleFilterChange);
            document.getElementById('allRegions').addEventListener('change', handleFilterChange);
            document.getElementById('searchBox').addEventListener('input', handleSearch);
            document.getElementById('refreshButton').addEventListener('click', handleRefresh);

            // Setup table sorting
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort(th.dataset.column));
            });

            // Setup column filters
            populateTierFilter();
            setupColumnFilters();
        }

        // Handle refresh button click
        function handleRefresh() {
            // Re-trigger the filter change to fetch fresh data
            handleFilterChange();
        }

        // Handle filter changes
        async function handleFilterChange() {
            // Cancel any ongoing request
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }

            const categorySelect = document.getElementById('categoryFilter');
            const tierSelect = document.getElementById('tierFilter');
            const raritySelect = document.getElementById('rarityFilter');

            // Get selected values as arrays
            const selectedCategories = Array.from(categorySelect.selectedOptions).map(opt => opt.value);
            const selectedTiers = Array.from(tierSelect.selectedOptions).map(opt => parseInt(opt.value));
            const selectedRarities = Array.from(raritySelect.selectedOptions).map(opt => opt.value);

            // If no filters are selected, show info message and hide results
            if (selectedCategories.length === 0 && selectedTiers.length === 0 && selectedRarities.length === 0) {
                document.getElementById('infoMessage').style.display = 'block';
                document.getElementById('resultsSection').classList.remove('active');
                showLoading(false);
                hideError();
                return;
            }

            document.getElementById('infoMessage').style.display = 'none';

            // Filter items based on selections
            const itemsToFetch = filterItems(selectedCategories, selectedTiers, selectedRarities);

            if (itemsToFetch.length === 0) {
                showError('No items match the selected filters');
                return;
            }

            // Fetch market data
            await fetchMarketData(itemsToFetch);
        }

        // Filter items based on category, tier, and rarity
        function filterItems(selectedCategories, selectedTiers, selectedRarities) {
            // Include cargo even if compendiumEntry is false
            let filtered = allItems.filter(item => item.compendiumEntry === true || item.itemType === 'cargo');

            // Filter by category (multiple selection)
            if (selectedCategories.length > 0) {
                filtered = filtered.filter(item => selectedCategories.includes(item.tag));
            } else {
                // If no category selected, only include items from the specified categories
                filtered = filtered.filter(item => CATEGORIES.includes(item.tag));
            }

            // Filter by tier (multiple selection)
            if (selectedTiers.length > 0) {
                filtered = filtered.filter(item => selectedTiers.includes(item.tier));
            }

            // Filter by rarity (multiple selection)
            if (selectedRarities.length > 0) {
                filtered = filtered.filter(item => selectedRarities.includes(item.rarityStr));
            }

            return filtered;
        }

        // Fetch market data - use bulk endpoint for all regions, individual calls for specific region
        async function fetchMarketData(items) {
            // Create new abort controller for this request
            currentAbortController = new AbortController();
            const signal = currentAbortController.signal;

            showLoading(true);
            hideError();

            const allRegionsChecked = document.getElementById('allRegions').checked;
            const targetRegionId = 4;

            try {
                const total = items.length;
                let gridData;

                if (allRegionsChecked) {
                    // Use bulk endpoint for all regions (batched in groups of 100)
                    const BULK_BATCH_SIZE = 100;
                    const mergedBulkData = { data: { items: {} } };

                    // Split into batches of 100 (API limit)
                    for (let i = 0; i < items.length; i += BULK_BATCH_SIZE) {
                        if (signal.aborted) {
                            console.log('Request cancelled by user');
                            return;
                        }

                        const batch = items.slice(i, i + BULK_BATCH_SIZE);
                        const batchItemIds = batch.filter(item => item.itemType !== 'cargo').map(item => parseInt(item.id));
                        const batchCargoIds = batch.filter(item => item.itemType === 'cargo').map(item => parseInt(item.id));

                        const batchNum = Math.floor(i / BULK_BATCH_SIZE) + 1;
                        const totalBatches = Math.ceil(items.length / BULK_BATCH_SIZE);

                        updateLoadingDetails(`Fetching batch ${batchNum}/${totalBatches} (${batch.length} items)...`);

                        const bulkApiUrl = `${API_BASE_URL}/api/market/prices/bulk`;
                        const response = await fetch(bulkApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                itemIds: batchItemIds,
                                cargoIds: batchCargoIds
                            }),
                            signal: signal
                        });

                        if (signal.aborted) {
                            console.log('Request cancelled by user');
                            return;
                        }

                        if (!response.ok) {
                            // Capture full error details
                            let responseBody = '';
                            try {
                                const contentType = response.headers.get('content-type');
                                if (contentType && contentType.includes('application/json')) {
                                    responseBody = JSON.stringify(await response.json(), null, 2);
                                } else {
                                    responseBody = await response.text();
                                }
                            } catch (e) {
                                responseBody = 'Could not read response body';
                            }

                            showLoading(false);
                            showError('Failed to fetch market data (bulk endpoint)', {
                                url: bulkApiUrl,
                                method: 'POST',
                                status: response.status,
                                statusText: response.statusText,
                                responseBody: responseBody
                            });
                            currentAbortController = null;
                            return;
                        }

                        const batchData = await response.json();

                        // Merge batch results into combined data
                        if (batchData && batchData.data && batchData.data.items) {
                            Object.assign(mergedBulkData.data.items, batchData.data.items);
                        }
                    }

                    // Process merged bulk data
                    gridData = processBulkDataToGrid(items, mergedBulkData);
                } else {
                    // Use individual calls for regional filtering
                    updateLoadingDetails(`Fetching ${total} items for specific region...`);

                    const results = [];
                    for (const item of items) {
                        if (signal.aborted) {
                            console.log('Request cancelled by user');
                            return;
                        }

                        try {
                            const apiUrl = `${API_BASE_URL}/api/market/item/${item.id}`;
                            const response = await fetch(apiUrl, { signal });
                            if (response.ok) {
                                const data = await response.json();
                                results.push({ item, data });
                            } else {
                                // Capture full error details
                                let responseBody = '';
                                try {
                                    const contentType = response.headers.get('content-type');
                                    if (contentType && contentType.includes('application/json')) {
                                        responseBody = JSON.stringify(await response.json(), null, 2);
                                    } else {
                                        responseBody = await response.text();
                                    }
                                } catch (e) {
                                    responseBody = 'Could not read response body';
                                }

                                console.error(`Failed to fetch item ${item.id}:`, response.status);
                                showLoading(false);
                                showError('Failed to fetch market data (individual item)', {
                                    url: apiUrl,
                                    method: 'GET',
                                    status: response.status,
                                    statusText: response.statusText,
                                    responseBody: responseBody
                                });
                                currentAbortController = null;
                                return;
                            }
                        } catch (error) {
                            if (error.name !== 'AbortError') {
                                console.error(`Error fetching item ${item.id}:`, error);
                            }
                            results.push({ item, data: null });
                        }
                    }

                    // Process individual order data with regional filtering
                    gridData = processResultsToGrid(results, allRegionsChecked, targetRegionId);
                }

                // Sort by default (tier, then itemName)
                currentSort = { column: 'tier', direction: 'asc' };
                sortResults(gridData);

                currentResults = gridData;
                displayResults(gridData);

                showLoading(false);
                currentAbortController = null;

                // Enable refresh button
                document.getElementById('refreshButton').disabled = false;
            } catch (error) {
                // Don't show error if request was aborted
                if (error.name === 'AbortError') {
                    console.log('Request was cancelled');
                    return;
                }
                showLoading(false);
                showError('Failed to fetch market data', {
                    error: error.message,
                    method: allRegionsChecked ? 'POST (bulk)' : 'GET (individual)'
                });
                currentAbortController = null;
            }
        }

        // Process bulk API data into grid format
        function processBulkDataToGrid(items, bulkData) {
            const grouped = {};

            if (!bulkData || !bulkData.data || !bulkData.data.items) {
                return [];
            }

            items.forEach(item => {
                const priceData = bulkData.data.items[item.id];
                if (!priceData || priceData.lowestSellPrice === null) return;

                const key = `${item.name}|${item.tier}|${item.tag}`;

                if (!grouped[key]) {
                    grouped[key] = {
                        itemName: item.name,
                        itemId: item.id,
                        tier: item.tier,
                        category: item.tag,
                        isCargo: item.itemType === 'cargo',
                        common: null,
                        commonItemId: null,
                        commonClaim: null,
                        uncommon: null,
                        uncommonItemId: null,
                        uncommonClaim: null,
                        rare: null,
                        rareItemId: null,
                        rareClaim: null,
                        epic: null,
                        epicItemId: null,
                        epicClaim: null,
                        legendary: null,
                        legendaryItemId: null,
                        legendaryClaim: null
                    };
                }

                const rarityKey = item.rarityStr.toLowerCase();
                const rarityIdKey = rarityKey + 'ItemId';
                const lowestPrice = priceData.lowestSellPrice;

                // Update the price if it's null or higher than the current lowest
                if (grouped[key][rarityKey] === null || lowestPrice < grouped[key][rarityKey]) {
                    grouped[key][rarityKey] = lowestPrice;
                    grouped[key][rarityIdKey] = item.id;
                }
            });

            return Object.values(grouped);
        }

        // Process API results into grid format
        function processResultsToGrid(results, includeAllRegions, targetRegionId) {
            // Group by (itemName, tier, category)
            const grouped = {};

            results.forEach(({ item, data }) => {
                if (!data || !data.sellOrders) return;

                const key = `${item.name}|${item.tier}|${item.tag}`;

                if (!grouped[key]) {
                    grouped[key] = {
                        itemName: item.name,
                        itemId: item.id,
                        tier: item.tier,
                        category: item.tag,
                        isCargo: item.itemType === 'cargo',
                        common: null,
                        commonItemId: null,
                        commonClaim: null,
                        uncommon: null,
                        uncommonItemId: null,
                        uncommonClaim: null,
                        rare: null,
                        rareItemId: null,
                        rareClaim: null,
                        epic: null,
                        epicItemId: null,
                        epicClaim: null,
                        legendary: null,
                        legendaryItemId: null,
                        legendaryClaim: null
                    };
                }

                // Filter sell orders by region if needed
                let sellOrders = data.sellOrders;
                if (!includeAllRegions) {
                    sellOrders = sellOrders.filter(order => order.regionId === targetRegionId);
                }

                // Find lowest price and its claim name
                if (sellOrders.length > 0) {
                    const lowestOrder = sellOrders.reduce((min, order) =>
                        parseFloat(order.priceThreshold) < parseFloat(min.priceThreshold) ? order : min
                    );
                    const lowestPrice = parseFloat(lowestOrder.priceThreshold);
                    const rarityKey = item.rarityStr.toLowerCase();
                    const rarityIdKey = rarityKey + 'ItemId';
                    const rarityClaimKey = rarityKey + 'Claim';

                    // Update the price if it's null or higher than the current lowest
                    if (grouped[key][rarityKey] === null || lowestPrice < grouped[key][rarityKey]) {
                        grouped[key][rarityKey] = lowestPrice;
                        grouped[key][rarityIdKey] = item.id;
                        grouped[key][rarityClaimKey] = lowestOrder.claimName;
                    }
                }
            });

            return Object.values(grouped);
        }

        // Display results in table
        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsBody = document.getElementById('resultsBody');
            const resultsCount = document.getElementById('resultsCount');

            resultsSection.classList.add('active');
            resultsCount.textContent = `${data.length} item${data.length !== 1 ? 's' : ''} found`;

            if (data.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="8" class="no-results">No results found</td></tr>';
                return;
            }

            resultsBody.innerHTML = data.map(row => `
                <tr>
                    <td><a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.itemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${row.isCargo ? '<span class="cargo-label">[Cargo]</span>' : ''}${row.itemName}</a></td>
                    <td>${row.tier}</td>
                    <td class="${row.common !== null ? 'price-cell' : 'price-na'}">
                        ${row.common !== null && row.commonItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.commonItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${row.common} hex</a>
                                 ${row.commonClaim ? `<div class="claim-name">${row.commonClaim}</div>` : ''}
                               </div>`
                            : (row.common !== null ? row.common + ' hex' : 'N/A')}
                    </td>
                    <td class="${row.uncommon !== null ? 'price-cell' : 'price-na'}">
                        ${row.uncommon !== null && row.uncommonItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.uncommonItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${row.uncommon} hex</a>
                                 ${row.uncommonClaim ? `<div class="claim-name">${row.uncommonClaim}</div>` : ''}
                               </div>`
                            : (row.uncommon !== null ? row.uncommon + ' hex' : 'N/A')}
                    </td>
                    <td class="${row.rare !== null ? 'price-cell' : 'price-na'}">
                        ${row.rare !== null && row.rareItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.rareItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${row.rare} hex</a>
                                 ${row.rareClaim ? `<div class="claim-name">${row.rareClaim}</div>` : ''}
                               </div>`
                            : (row.rare !== null ? row.rare + ' hex' : 'N/A')}
                    </td>
                    <td class="${row.epic !== null ? 'price-cell' : 'price-na'}">
                        ${row.epic !== null && row.epicItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.epicItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${row.epic} hex</a>
                                 ${row.epicClaim ? `<div class="claim-name">${row.epicClaim}</div>` : ''}
                               </div>`
                            : (row.epic !== null ? row.epic + ' hex' : 'N/A')}
                    </td>
                    <td class="${row.legendary !== null ? 'price-cell' : 'price-na'}">
                        ${row.legendary !== null && row.legendaryItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.legendaryItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${row.legendary} hex</a>
                                 ${row.legendaryClaim ? `<div class="claim-name">${row.legendaryClaim}</div>` : ''}
                               </div>`
                            : (row.legendary !== null ? row.legendary + ' hex' : 'N/A')}
                    </td>
                    <td>${row.category}</td>
                </tr>
            `).join('');
        }

        // Handle search/filter
        function handleSearch(e) {
            applyAllFilters();
        }

        // Apply all filters (quick search + column filters)
        function applyAllFilters() {
            let filtered = [...currentResults];
            const totalCount = currentResults.length;

            // Quick search filter
            const quickSearch = document.getElementById('searchBox').value.toLowerCase().trim();
            if (quickSearch) {
                filtered = filtered.filter(row =>
                    row.itemName.toLowerCase().includes(quickSearch) ||
                    row.category.toLowerCase().includes(quickSearch)
                );
            }

            // Column filters
            const filterItemName = document.getElementById('filterItemName')?.value.toLowerCase().trim();
            const filterTier = document.getElementById('filterTier')?.value;
            const filterCategory = document.getElementById('filterCategory')?.value.toLowerCase().trim();
            const filterMinPrice = parseFloat(document.getElementById('filterMinPrice')?.value);
            const filterMaxPrice = parseFloat(document.getElementById('filterMaxPrice')?.value);
            const filterRarity = document.getElementById('filterRarity')?.value;

            // Apply item name filter
            if (filterItemName) {
                filtered = filtered.filter(row =>
                    row.itemName.toLowerCase().includes(filterItemName)
                );
            }

            // Apply tier filter
            if (filterTier) {
                filtered = filtered.filter(row => row.tier == filterTier);
            }

            // Apply category filter
            if (filterCategory) {
                filtered = filtered.filter(row =>
                    row.category.toLowerCase().includes(filterCategory)
                );
            }

            // Apply price filters (check if ANY rarity price falls within range)
            if (!isNaN(filterMinPrice) || !isNaN(filterMaxPrice)) {
                filtered = filtered.filter(row => {
                    const prices = [row.common, row.uncommon, row.rare, row.epic, row.legendary]
                        .filter(p => p !== null);

                    if (prices.length === 0) return false;

                    const minCheck = isNaN(filterMinPrice) || prices.some(p => p >= filterMinPrice);
                    const maxCheck = isNaN(filterMaxPrice) || prices.some(p => p <= filterMaxPrice);

                    return minCheck && maxCheck;
                });
            }

            // Apply rarity-specific filter (show only items with that rarity available)
            if (filterRarity) {
                filtered = filtered.filter(row => {
                    return row[filterRarity] !== null;
                });
            }

            // Update results count with filter status
            const resultsCount = document.getElementById('resultsCount');
            if (filtered.length < totalCount) {
                resultsCount.textContent = `${filtered.length} of ${totalCount} items (filtered)`;
                resultsCount.style.color = '#fb923c'; // Orange to indicate filtering
            } else {
                resultsCount.textContent = `${filtered.length} item${filtered.length !== 1 ? 's' : ''} found`;
                resultsCount.style.color = '#4a9eff'; // Blue default
            }

            displayResults(filtered);
        }

        // Toggle column filters panel
        function toggleColumnFilters() {
            const panel = document.getElementById('columnFiltersPanel');
            const button = document.getElementById('columnFilterToggle');

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.textContent = 'üîç Hide Filters';
                button.style.backgroundColor = '#6b7280';
            } else {
                panel.style.display = 'none';
                button.textContent = 'üîç Column Filters';
                button.style.backgroundColor = '#a78bfa';
            }
        }

        // Clear all column filters
        function clearColumnFilters() {
            document.getElementById('filterItemName').value = '';
            document.getElementById('filterTier').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterMinPrice').value = '';
            document.getElementById('filterMaxPrice').value = '';
            document.getElementById('filterRarity').value = '';

            applyAllFilters();
            showToast('All filters cleared', 'success');
        }

        // Populate tier filter dropdown
        function populateTierFilter() {
            const filterTier = document.getElementById('filterTier');
            const tiers = [...new Set(allItems.map(item => item.tier))].sort((a, b) => a - b);

            tiers.forEach(tier => {
                const option = document.createElement('option');
                option.value = tier;
                option.textContent = `Tier ${tier}`;
                filterTier.appendChild(option);
            });
        }

        // Setup column filter event listeners
        function setupColumnFilters() {
            document.getElementById('filterItemName').addEventListener('input', BitcraftUtils.debounce(applyAllFilters, 300));
            document.getElementById('filterTier').addEventListener('change', applyAllFilters);
            document.getElementById('filterCategory').addEventListener('input', BitcraftUtils.debounce(applyAllFilters, 300));
            document.getElementById('filterMinPrice').addEventListener('input', BitcraftUtils.debounce(applyAllFilters, 300));
            document.getElementById('filterMaxPrice').addEventListener('input', BitcraftUtils.debounce(applyAllFilters, 300));
            document.getElementById('filterRarity').addEventListener('change', applyAllFilters);
        }

        // Handle column sorting
        function handleSort(column) {
            // Toggle direction if clicking same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            sortResults(currentResults);
            displayResults(currentResults);

            // Update column headers
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Sort results array
        function sortResults(data) {
            const { column, direction } = currentSort;
            const multiplier = direction === 'asc' ? 1 : -1;

            data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle null values for price columns
                if (aVal === null) aVal = Infinity;
                if (bVal === null) bVal = Infinity;

                let comparison = 0;
                if (typeof aVal === 'string') {
                    comparison = multiplier * aVal.localeCompare(bVal);
                } else {
                    comparison = multiplier * (aVal - bVal);
                }

                // Secondary sort by itemName when sorting by tier
                if (comparison === 0 && column === 'tier') {
                    comparison = a.itemName.localeCompare(b.itemName);
                }

                return comparison;
            });
        }

        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // Update loading details text
        function updateLoadingDetails(text) {
            document.getElementById('loadingDetails').textContent = text;
        }

        // Show error message with detailed information
        function showError(message, details = null) {
            const errorElement = document.getElementById('errorMessage');

            // Create detailed error message
            let errorHtml = `<strong>Error:</strong> ${message}`;

            if (details) {
                errorHtml += '<br><br><strong>Details:</strong><br>';

                if (details.url) {
                    errorHtml += `<strong>URL:</strong> ${details.url}<br>`;
                }

                if (details.status) {
                    errorHtml += `<strong>Status:</strong> ${details.status} ${details.statusText || ''}<br>`;
                }

                if (details.method) {
                    errorHtml += `<strong>Method:</strong> ${details.method}<br>`;
                }

                if (details.responseBody) {
                    errorHtml += `<strong>Response:</strong> <pre style="background: #f5f5f5; padding: 8px; margin-top: 4px; overflow-x: auto; white-space: pre-wrap;">${details.responseBody}</pre>`;
                }

                if (details.error) {
                    errorHtml += `<strong>Error Message:</strong> ${details.error}<br>`;
                }
            }

            errorElement.innerHTML = errorHtml;
            errorElement.classList.add('active');
        }

        // Hide error message
        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            errorElement.classList.remove('active');
        }

        // Initialize app
        loadItems();

        // ==========================================
        // URL STATE MANAGEMENT
        // ==========================================

        // Restore state from URL on page load
        function restoreFromUrl() {
            const params = BitcraftUtils.getUrlParams();

            const categorySelect = document.getElementById('categoryFilter');
            const tierSelect = document.getElementById('tierFilter');
            const raritySelect = document.getElementById('rarityFilter');

            // Restore categories
            if (params.categories) {
                const categories = Array.isArray(params.categories) ? params.categories : [params.categories];
                Array.from(categorySelect.options).forEach(opt => {
                    opt.selected = categories.includes(opt.value);
                });
            }

            // Restore tiers
            if (params.tiers) {
                const tiers = Array.isArray(params.tiers) ? params.tiers : [params.tiers];
                Array.from(tierSelect.options).forEach(opt => {
                    opt.selected = tiers.includes(opt.value);
                });
            }

            // Restore rarities
            if (params.rarities) {
                const rarities = Array.isArray(params.rarities) ? params.rarities : [params.rarities];
                Array.from(raritySelect.options).forEach(opt => {
                    opt.selected = rarities.includes(opt.value);
                });
            }

            // Restore region filter
            if (params.allRegions === 'true') {
                document.getElementById('allRegions').checked = true;
            }

            // Auto-trigger search if filters are present
            if (params.categories || params.tiers || params.rarities) {
                setTimeout(() => handleFilterChange(), 500);
            }
        }

        // Update URL when filters change
        function updateUrl() {
            const categorySelect = document.getElementById('categoryFilter');
            const tierSelect = document.getElementById('tierFilter');
            const raritySelect = document.getElementById('rarityFilter');

            const params = {};

            const selectedCategories = Array.from(categorySelect.selectedOptions).map(opt => opt.value);
            if (selectedCategories.length > 0) {
                params.categories = selectedCategories;
            }

            const selectedTiers = Array.from(tierSelect.selectedOptions).map(opt => opt.value);
            if (selectedTiers.length > 0) {
                params.tiers = selectedTiers;
            }

            const selectedRarities = Array.from(raritySelect.selectedOptions).map(opt => opt.value);
            if (selectedRarities.length > 0) {
                params.rarities = selectedRarities;
            }

            const allRegions = document.getElementById('allRegions').checked;
            if (allRegions) {
                params.allRegions = 'true';
            }

            BitcraftUtils.setUrlParams(params, true);
        }

        // Call restoreFromUrl after dropdowns are populated
        setTimeout(restoreFromUrl, 500);

        // Add event listeners to update URL when filters change
        document.getElementById('categoryFilter').addEventListener('change', updateUrl);
        document.getElementById('tierFilter').addEventListener('change', updateUrl);
        document.getElementById('rarityFilter').addEventListener('change', updateUrl);
        document.getElementById('allRegions').addEventListener('change', updateUrl);

        // ==========================================
        // ENHANCED PRICE DISPLAY IN TABLES
        // ==========================================

        // Override displayResults to use better price formatting
        const originalDisplayResults = displayResults;
        displayResults = function(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsBody = document.getElementById('resultsBody');
            const resultsCount = document.getElementById('resultsCount');

            resultsSection.classList.add('active');
            resultsCount.textContent = `${data.length} item${data.length !== 1 ? 's' : ''} found`;

            if (data.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="8" class="no-results">No results found</td></tr>';
                return;
            }

            resultsBody.innerHTML = data.map(row => `
                <tr>
                    <td><a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.itemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${row.isCargo ? '<span class="cargo-label">[Cargo]</span>' : ''}${row.itemName}</a></td>
                    <td>${row.tier}</td>
                    <td class="${row.common !== null ? 'price-cell' : 'price-na'}">
                        ${row.common !== null && row.commonItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.commonItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${BitcraftUtils.formatPrice(row.common)}</a>
                                 ${row.commonClaim ? `<div class="claim-name">${row.commonClaim}</div>` : ''}
                               </div>`
                            : (row.common !== null ? BitcraftUtils.formatPrice(row.common) : 'N/A')}
                    </td>
                    <td class="${row.uncommon !== null ? 'price-cell' : 'price-na'}">
                        ${row.uncommon !== null && row.uncommonItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.uncommonItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${BitcraftUtils.formatPrice(row.uncommon)}</a>
                                 ${row.uncommonClaim ? `<div class="claim-name">${row.uncommonClaim}</div>` : ''}
                               </div>`
                            : (row.uncommon !== null ? BitcraftUtils.formatPrice(row.uncommon) : 'N/A')}
                    </td>
                    <td class="${row.rare !== null ? 'price-cell' : 'price-na'}">
                        ${row.rare !== null && row.rareItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.rareItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${BitcraftUtils.formatPrice(row.rare)}</a>
                                 ${row.rareClaim ? `<div class="claim-name">${row.rareClaim}</div>` : ''}
                               </div>`
                            : (row.rare !== null ? BitcraftUtils.formatPrice(row.rare) : 'N/A')}
                    </td>
                    <td class="${row.epic !== null ? 'price-cell' : 'price-na'}">
                        ${row.epic !== null && row.epicItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.epicItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${BitcraftUtils.formatPrice(row.epic)}</a>
                                 ${row.epicClaim ? `<div class="claim-name">${row.epicClaim}</div>` : ''}
                               </div>`
                            : (row.epic !== null ? BitcraftUtils.formatPrice(row.epic) : 'N/A')}
                    </td>
                    <td class="${row.legendary !== null ? 'price-cell' : 'price-na'}">
                        ${row.legendary !== null && row.legendaryItemId
                            ? `<div class="price-with-claim">
                                 <a href="https://bitjita.com/market/${row.isCargo ? 'cargo' : 'item'}/${row.legendaryItemId}?q=${encodeURIComponent(row.itemName.toLowerCase())}&hasOrders=true" target="_blank" class="item-link">${BitcraftUtils.formatPrice(row.legendary)}</a>
                                 ${row.legendaryClaim ? `<div class="claim-name">${row.legendaryClaim}</div>` : ''}
                               </div>`
                            : (row.legendary !== null ? BitcraftUtils.formatPrice(row.legendary) : 'N/A')}
                    </td>
                    <td>${row.category}</td>
                </tr>
            `).join('');
        };

        // ==========================================
        // SAVED SEARCHES FUNCTIONALITY
        // ==========================================

        // Initialize saved searches UI
        function initSavedSearches() {
            updateSavedSearchesDropdown();
            updateSavedIndicator();

            // Listen for storage changes from other tabs
            SavedSearches.onStorageChange(() => {
                updateSavedSearchesDropdown();
                updateSavedIndicator();
            });
        }

        // Get current filter configuration
        function getCurrentConfig() {
            const categorySelect = document.getElementById('categoryFilter');
            const tierSelect = document.getElementById('tierFilter');
            const raritySelect = document.getElementById('rarityFilter');

            return {
                categories: Array.from(categorySelect.selectedOptions).map(opt => opt.value),
                tiers: Array.from(tierSelect.selectedOptions).map(opt => parseInt(opt.value)),
                rarities: Array.from(raritySelect.selectedOptions).map(opt => opt.value)
            };
        }

        // Load configuration into filters
        function loadConfig(config) {
            const categorySelect = document.getElementById('categoryFilter');
            const tierSelect = document.getElementById('tierFilter');
            const raritySelect = document.getElementById('rarityFilter');

            // Clear all selections
            Array.from(categorySelect.options).forEach(opt => opt.selected = false);
            Array.from(tierSelect.options).forEach(opt => opt.selected = false);
            Array.from(raritySelect.options).forEach(opt => opt.selected = false);

            // Apply saved selections
            if (config.categories) {
                config.categories.forEach(val => {
                    const opt = Array.from(categorySelect.options).find(o => o.value === val);
                    if (opt) opt.selected = true;
                });
            }

            if (config.tiers) {
                config.tiers.forEach(val => {
                    const opt = Array.from(tierSelect.options).find(o => parseInt(o.value) === val);
                    if (opt) opt.selected = true;
                });
            }

            if (config.rarities) {
                config.rarities.forEach(val => {
                    const opt = Array.from(raritySelect.options).find(o => o.value === val);
                    if (opt) opt.selected = true;
                });
            }
        }

        // Update saved searches dropdown
        function updateSavedSearchesDropdown() {
            const select = document.getElementById('savedSearchSelect');
            const searches = SavedSearches.getAll('gear-finder');

            // Clear and rebuild dropdown
            select.innerHTML = '<option value="">-- Load Saved Search --</option>';

            searches
                .sort((a, b) => b.timestamp - a.timestamp)
                .forEach(search => {
                    const option = document.createElement('option');
                    option.value = search.id;
                    option.textContent = search.name;
                    select.appendChild(option);
                });
        }

        // Check if current filters match a saved search
        function updateSavedIndicator() {
            const config = getCurrentConfig();

            // Only check if at least one filter is selected
            const hasFilters = config.categories.length > 0 ||
                              config.tiers.length > 0 ||
                              config.rarities.length > 0;

            if (!hasFilters) {
                document.getElementById('savedIndicator').style.display = 'none';
                return;
            }

            const duplicate = SavedSearches.findDuplicate(config, 'gear-finder');
            document.getElementById('savedIndicator').style.display = duplicate ? 'inline' : 'none';
        }

        // Save current filters
        document.getElementById('saveSearchButton').addEventListener('click', function() {
            const config = getCurrentConfig();

            // Check if at least one filter is selected
            const hasFilters = config.categories.length > 0 ||
                              config.tiers.length > 0 ||
                              config.rarities.length > 0;

            if (!hasFilters) {
                showToast('Please select at least one filter first', 'error');
                return;
            }

            // Generate default name
            const parts = [];
            if (config.tiers.length > 0) {
                parts.push(`Tier ${config.tiers.sort((a, b) => a - b).join(',')}`);
            }
            if (config.categories.length > 0) {
                parts.push(config.categories[0]);
                if (config.categories.length > 1) {
                    parts.push(`+${config.categories.length - 1} more`);
                }
            }
            if (config.rarities.length > 0) {
                parts.push(config.rarities[0]);
                if (config.rarities.length > 1) {
                    parts.push(`+${config.rarities.length - 1} more`);
                }
            }
            const defaultName = parts.join(' - ') || 'Untitled Search';

            // Prompt for custom name
            const customName = prompt('Enter a name for this search:', defaultName);

            if (customName === null) {
                return; // User cancelled
            }

            const result = SavedSearches.save(config, 'gear-finder', customName.trim() || null);

            if (result.success) {
                showToast('Filters saved successfully!', 'success');
                updateSavedSearchesDropdown();
                updateSavedIndicator();

                if (result.warning) {
                    showToast(result.warning, 'warning');
                }
            } else {
                showToast(result.error, 'error');
            }
        });

        // Load saved search
        document.getElementById('savedSearchSelect').addEventListener('change', function() {
            const searchId = this.value;

            if (!searchId) return;

            const search = SavedSearches.getById(searchId);

            if (search) {
                // Load config into filters
                loadConfig(search.config);

                // Trigger filter change to load data
                handleFilterChange();

                showToast(`Loaded: ${search.name}`, 'success');
            } else {
                showToast('Search not found', 'error');
            }

            // Reset dropdown
            this.value = '';
        });

        // Update indicator when filters change
        document.getElementById('categoryFilter').addEventListener('change', updateSavedIndicator);
        document.getElementById('tierFilter').addEventListener('change', updateSavedIndicator);
        document.getElementById('rarityFilter').addEventListener('change', updateSavedIndicator);

        // Open manage modal
        document.getElementById('manageSearchesButton').addEventListener('click', function() {
            openManageModal();
        });

        function openManageModal() {
            renderSavedSearchesList();
            document.getElementById('manageSearchesModal').classList.add('active');
        }

        function closeManageModal() {
            document.getElementById('manageSearchesModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('manageSearchesModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeManageModal();
            }
        });

        // Render saved searches list in modal
        function renderSavedSearchesList() {
            const container = document.getElementById('savedSearchesList');
            const searches = SavedSearches.getAll('gear-finder');

            if (searches.length === 0) {
                container.innerHTML = '<div class="empty-state">No saved searches yet. Save your first search to quickly access it later!</div>';
                return;
            }

            // Sort by timestamp (newest first)
            searches.sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = searches.map(search => {
                const date = new Date(search.timestamp).toLocaleString();

                // Build description
                const parts = [];
                if (search.config.categories && search.config.categories.length > 0) {
                    parts.push(`Categories: ${search.config.categories.join(', ')}`);
                }
                if (search.config.tiers && search.config.tiers.length > 0) {
                    parts.push(`Tiers: ${search.config.tiers.join(', ')}`);
                }
                if (search.config.rarities && search.config.rarities.length > 0) {
                    parts.push(`Rarities: ${search.config.rarities.join(', ')}`);
                }
                const description = parts.join(' ‚Ä¢ ');

                return `
                    <div class="saved-search-item">
                        <div class="saved-search-header">
                            <div class="saved-search-name">${escapeHtml(search.name)}</div>
                            <div class="saved-search-actions">
                                <button class="saved-search-btn load" onclick="loadSavedSearch('${search.id}')">üìÇ Load</button>
                                <button class="saved-search-btn" onclick="renameSavedSearch('${search.id}')">‚úèÔ∏è Rename</button>
                                <button class="saved-search-btn delete" onclick="deleteSavedSearch('${search.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div class="saved-search-details">
                            <span class="saved-search-type">Gear Finder</span>
                            ${description}
                            <br><small>Saved: ${date}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load saved search from modal
        function loadSavedSearch(id) {
            const search = SavedSearches.getById(id);

            if (search) {
                // Load config into filters
                loadConfig(search.config);

                // Trigger filter change to load data
                handleFilterChange();

                closeManageModal();
                showToast(`Loaded: ${search.name}`, 'success');
            } else {
                showToast('Search not found', 'error');
            }
        }

        // Rename saved search
        function renameSavedSearch(id) {
            const search = SavedSearches.getById(id);

            if (!search) {
                showToast('Search not found', 'error');
                return;
            }

            const newName = prompt('Enter new name:', search.name);

            if (newName === null) {
                return; // User cancelled
            }

            if (newName.trim()) {
                const result = SavedSearches.update(id, { name: newName.trim() });

                if (result.success) {
                    showToast('Search renamed successfully', 'success');
                    renderSavedSearchesList();
                    updateSavedSearchesDropdown();
                } else {
                    showToast(result.error, 'error');
                }
            } else {
                showToast('Name cannot be empty', 'error');
            }
        }

        // Delete saved search
        function deleteSavedSearch(id) {
            const search = SavedSearches.getById(id);

            if (!search) {
                showToast('Search not found', 'error');
                return;
            }

            if (!confirm(`Delete "${search.name}"?`)) {
                return;
            }

            const result = SavedSearches.delete(id);

            if (result.success) {
                showToast('Search deleted successfully', 'success');
                renderSavedSearchesList();
                updateSavedSearchesDropdown();
                updateSavedIndicator();
            } else {
                showToast(result.error, 'error');
            }
        }

        // Export searches
        function exportSearches() {
            const searches = SavedSearches.getAll('gear-finder');

            if (searches.length === 0) {
                showToast('No searches to export', 'warning');
                return;
            }

            const json = SavedSearches.exportToJSON();
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bitcraft-gear-finder-searches-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Searches exported successfully', 'success');
        }

        // Import searches
        function importSearches() {
            const fileInput = document.getElementById('importFileInput');

            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const result = SavedSearches.importFromJSON(event.target.result, true);

                    if (result.success) {
                        showToast(`Imported ${result.imported} searches (${result.total} total)`, 'success');
                        renderSavedSearchesList();
                        updateSavedSearchesDropdown();

                        if (result.warning) {
                            showToast(result.warning, 'warning');
                        }
                    } else {
                        showToast(result.error, 'error');
                    }
                };
                reader.readAsText(file);

                // Reset file input
                fileInput.value = '';
            };

            fileInput.click();
        }

        // Clear all searches
        function clearAllSearches() {
            const searches = SavedSearches.getAll('gear-finder');

            if (searches.length === 0) {
                showToast('No searches to clear', 'warning');
                return;
            }

            if (!confirm(`Delete all ${searches.length} saved searches? This cannot be undone.`)) {
                return;
            }

            const result = SavedSearches.clear();

            if (result.success) {
                showToast('All searches cleared', 'success');
                renderSavedSearchesList();
                updateSavedSearchesDropdown();
                updateSavedIndicator();
            } else {
                showToast(result.error, 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // HTML escape helper
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Initialize saved searches on page load
        window.addEventListener('DOMContentLoaded', initSavedSearches);

        // ==========================================
        // UI VERSION TOGGLE
        // ==========================================
        function initVersionToggle() {
            const toggle = document.getElementById('uiVersionToggle');
            const sharedStyles = document.getElementById('sharedStyles');
            const savedVersion = localStorage.getItem('bitcraftMarketHelper_uiVersion');

            if (savedVersion === 'enhanced') {
                toggle.checked = true;
                sharedStyles.disabled = false;
                document.body.classList.add('enhanced-ui');
            }

            toggle.addEventListener('change', function() {
                if (this.checked) {
                    sharedStyles.disabled = false;
                    document.body.classList.add('enhanced-ui');
                    localStorage.setItem('bitcraftMarketHelper_uiVersion', 'enhanced');
                } else {
                    sharedStyles.disabled = true;
                    document.body.classList.remove('enhanced-ui');
                    localStorage.setItem('bitcraftMarketHelper_uiVersion', 'classic');
                }
            });
        }

        window.addEventListener('DOMContentLoaded', initVersionToggle);

        // Initialize player search on page load
        window.addEventListener('DOMContentLoaded', initPlayerSearch);

        // ==========================================
        // EXPORT TO CSV
        // ==========================================

        function exportToCSV() {
            if (currentResults.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }

            // CSV headers
            const headers = ['Item Name', 'Tier', 'Common', 'Uncommon', 'Rare', 'Epic', 'Legendary', 'Category'];

            // CSV rows
            const rows = currentResults.map(row => [
                row.itemName,
                row.tier,
                row.common !== null ? row.common : 'N/A',
                row.uncommon !== null ? row.uncommon : 'N/A',
                row.rare !== null ? row.rare : 'N/A',
                row.epic !== null ? row.epic : 'N/A',
                row.legendary !== null ? row.legendary : 'N/A',
                row.category
            ]);

            // Create CSV content
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bitcraft-gear-prices-${Date.now()}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast('CSV exported successfully!', 'success');
        }
    </script>
</body>
</html>
